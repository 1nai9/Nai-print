<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù„ÙˆØ­Ø© Ø±Ø³Ù… â€” Neon Blue</title>
<style>
  :root{
    --bg:#010114;
    --panel:#06102a;
    --accent1:#0af;
    --accent2:#6bf;
    --white:#eaf6ff;
    --glass: rgba(255,255,255,0.04);
  }
  *{box-sizing:border-box;font-family: "Poppins", system-ui, sans-serif}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#000016);color:var(--white)}
  .app{
    display:flex;
    gap:14px;
    padding:18px;
    height:100vh;
  }

  /* Ù„ÙˆØ­Ø© Ø§Ù„Ø§Ø¯ÙˆØ§Øª Ø§Ù„Ø´Ù…Ø§Ù„ (Ø£Ùˆ Ø§Ù„ÙŠÙ…ÙŠÙ† Ø­Ø³Ø¨ dir) */
  .sidebar{
    width:320px;
    max-width:40%;
    background:linear-gradient(180deg, rgba(8,16,40,0.6), rgba(6,10,26,0.55));
    border:1px solid rgba(10,40,90,0.18);
    border-radius:12px;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:12px;
    backdrop-filter: blur(6px);
  }
  .logo{
    display:flex;align-items:center;gap:10px;
  }
  .logo .mark{
    width:46px;height:46px;border-radius:10px;
    background:linear-gradient(135deg,var(--accent1),var(--accent2));
    box-shadow:0 6px 30px rgba(10,150,255,0.14), inset 0 -6px 20px rgba(255,255,255,0.06);
    display:flex;align-items:center;justify-content:center;color:#001;
    font-weight:700;font-size:20px;
  }
  h1{margin:0;font-size:16px}
  .controls{display:flex;flex-direction:column;gap:8px}

  .row{display:flex;gap:8px;align-items:center}
  .big{font-size:13px}
  input[type=range]{width:100%}
  button{
    background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border:1px solid rgba(160,200,255,0.06);
    color:var(--white);padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;
  }
  .btn-primary{
    background:linear-gradient(90deg,var(--accent1),var(--accent2));
    color:#001;border:none;box-shadow:0 6px 20px rgba(10,140,255,0.12);
  }
  .tools{
    display:flex;gap:8px;flex-wrap:wrap;
  }
  .tool{
    display:flex;flex-direction:column;gap:6px;padding:8px;border-radius:8px;
    min-width:64px;align-items:center;justify-content:center;
    background:var(--glass);border:1px solid rgba(255,255,255,0.02)
  }

  /* Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø³Ù… */
  .stage{
    flex:1;
    position:relative;
    border-radius:12px;
    overflow:hidden;
    display:flex;flex-direction:column;
    border:1px solid rgba(10,30,70,0.14);
    background:linear-gradient(180deg, rgba(2,6,20,0.85), rgba(0,0,6,0.6));
  }

  /* Ø´Ø±ÙŠØ· Ø§Ø¹Ù„Ù‰ */
  .topbar{
    display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.03);
    gap:10px;
  }
  .canvas-wrap{position:relative;flex:1;display:flex;align-items:center;justify-content:center;background:
    radial-gradient(ellipse at center, rgba(10,20,40,0.2) 0%, rgba(0,0,7,0.6) 40%, transparent 60%);}

  /* Ø·Ø¨Ù‚Ø§Øª Ù…ØªØ±Ø§ÙƒØ¨Ø© */
  .layer{
    position:absolute;left:0;top:0;
  }

  /* Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø¨Ù‚Ø§Øª */
  .layers-panel{
    background:linear-gradient(180deg, rgba(1,8,22,0.35), rgba(3,8,12,0.25));
    border-radius:8px;padding:8px;border:1px solid rgba(10,30,70,0.12);max-height:320px;overflow:auto;
  }
  .layer-item{
    display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;margin-bottom:6px;
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.0));
    border:1px solid rgba(255,255,255,0.02);
  }
  .layer-thumb{width:46px;height:32px;border-radius:6px;background:linear-gradient(45deg,#001,#002);overflow:hidden;display:flex;align-items:center;justify-content:center;color:#77b;}
  .layer-meta{flex:1;display:flex;flex-direction:column}
  .layer-actions{display:flex;gap:6px;align-items:center}
  .small{font-size:12px;color:rgba(230,240,255,0.9)}

  /* Ù…ÙˆØ¨Ø§ÙŠÙ„ */
  @media (max-width:900px){
    .app{flex-direction:column;padding:8px}
    .sidebar{width:100%;max-width:100%;order:2}
    .stage{order:1;height:60vh}
  }

  /* ØªØ£Ø«ÙŠØ± Ù†ÙŠÙˆÙ† Ø®ÙÙŠÙ */
  .neon {
    text-shadow:0 0 8px rgba(10,170,255,0.25), 0 0 20px rgba(80,150,255,0.06);
    color:var(--white);
  }
</style>
</head>
<body>
<div class="app" aria-live="polite">
  <aside class="sidebar" role="complementary">
    <div class="logo">
      <div class="mark">R</div>
      <div>
        <h1 class="neon">Ù„ÙˆØ­Ø© Ø±Ø³Ù… â€” Neon Blue</h1>
        <div class="small">Ù†Ø¸Ø§Ù… Ø·Ø¨Ù‚Ø§Øª Â· Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Â· ØªØµØ¯ÙŠØ± PNG</div>
      </div>
    </div>

    <div class="controls">
      <div class="row">
        <label class="big">Ø£Ø¯Ø§Ø©:</label>
        <div class="tools" style="flex:1">
          <button id="brushBtn" class="tool">âœï¸ ÙØ±Ø´Ø§Ø©</button>
          <button id="eraserBtn" class="tool">ğŸ§½ Ù…Ù…Ø­Ø§Ø©</button>
          <button id="moveBtn" class="tool">âœ‹ Ù†Ù‚Ù„</button>
        </div>
      </div>

      <div class="row">
        <label class="big">Ø§Ù„Ù„ÙˆÙ†:</label>
        <input id="color" type="color" value="#00bfff" style="width:64px;height:36px;padding:2px;border-radius:8px;border:none;background:#000"/>
        <button id="whiteBtn" class="btn-primary" title="Ø£Ø¨ÙŠØ¶">Ø£Ø¨ÙŠØ¶</button>
      </div>

      <div class="row">
        <label class="big">Ø­Ø¬Ù… Ø§Ù„ÙØ±Ø´Ø§Ø©:</label>
        <input id="size" type="range" min="1" max="120" value="8"/>
        <div style="width:52px;text-align:center" id="sizeVal">8</div>
      </div>

      <div class="row">
        <label class="big">Ø´ÙØ§ÙÙŠØ© Ø§Ù„Ø·Ø¨Ù‚Ø©:</label>
        <input id="opacity" type="range" min="0" max="100" value="100"/>
        <div style="width:52px;text-align:center" id="opacityVal">100%</div>
      </div>

      <div class="row">
        <button id="addLayer" class="btn-primary" style="flex:1">+ Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø©</button>
        <button id="exportBtn" style="flex:1">ØªØ­Ù…ÙŠÙ„ PNG</button>
      </div>

      <div class="row">
        <button id="clearLayer" style="flex:1">Ù…Ø³Ø­ Ø§Ù„Ø·Ø¨Ù‚Ø©</button>
        <button id="flattenBtn" style="flex:1">Ø¯Ù…Ø¬ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª ÙˆØ­ÙØ¸</button>
      </div>

      <div>
        <div class="small" style="margin-bottom:8px">Ø§Ù„Ø·Ø¨Ù‚Ø§Øª</div>
        <div class="layers-panel" id="layersPanel" aria-live="polite"></div>
      </div>

      <div class="small" style="opacity:0.8">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø³Ø­Ø¨/Ø§Ù„Ø±Ø³Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø§Ù„Ù„Ù…Ø³ ÙˆØ§Ù„ÙØ£Ø±Ø©. ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ù…ØªØµÙØ­.</div>
    </div>
  </aside>

  <main class="stage" role="main">
    <div class="topbar">
      <div class="small">Ø­Ø¬Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ù…: <span id="canvasSizeLabel">1024 Ã— 768</span></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="undoBtn">ØªØ±Ø§Ø¬Ø¹</button>
        <button id="redoBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
        <button id="downloadLayers">ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ù„Ø§ÙŠØ±Ø² (ZIP)</button>
      </div>
    </div>

    <div class="canvas-wrap" id="canvasWrap">
      <!-- canvases Ø³ÙŠØªÙ… Ø§Ø¶Ø§ÙØªÙ‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ -->
    </div>
  </main>
</div>

<script>
/* ====== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© ====== */
const DEFAULT_WIDTH = 1024;
const DEFAULT_HEIGHT = 768;

const canvasWrap = document.getElementById('canvasWrap');
const layersPanel = document.getElementById('layersPanel');

let layers = []; // Ù…ØµÙÙˆÙØ© Ø§Ù„Ø·Ø¨Ù‚Ø§Øª {id, canvas, ctx, name, visible, locked, opacity}
let activeLayerId = null;
let tool = 'brush'; // brush | eraser | move
let colorInput = document.getElementById('color');
const sizeInput = document.getElementById('size');
const sizeVal = document.getElementById('sizeVal');
const opacityInput = document.getElementById('opacity');
const opacityVal = document.getElementById('opacityVal');

sizeInput.oninput = ()=> sizeVal.textContent = sizeInput.value;
opacityInput.oninput = ()=> opacityVal.textContent = opacityInput.value + '%';

document.getElementById('brushBtn').onclick = ()=> setTool('brush');
document.getElementById('eraserBtn').onclick = ()=> setTool('eraser');
document.getElementById('moveBtn').onclick = ()=> setTool('move');
document.getElementById('whiteBtn').onclick = ()=> { colorInput.value = '#ffffff'; }

document.getElementById('addLayer').onclick = ()=> addLayer();
document.getElementById('exportBtn').onclick = ()=> exportPNG();
document.getElementById('clearLayer').onclick = ()=> clearActiveLayer();
document.getElementById('flattenBtn').onclick = ()=> exportFlattenedPNG();
document.getElementById('undoBtn').onclick = ()=> undo();
document.getElementById('redoBtn').onclick = ()=> redo();

document.getElementById('downloadLayers').onclick = ()=> downloadLayersAsImages();

document.getElementById('canvasSizeLabel').textContent = DEFAULT_WIDTH + ' Ã— ' + DEFAULT_HEIGHT;

/* ====== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ø¨Ù‚Ø§Øª ====== */
function createCanvasLayer(w=DEFAULT_WIDTH,h=DEFAULT_HEIGHT){
  const c = document.createElement('canvas');
  c.className = 'layer';
  c.width = w; c.height = h;
  c.style.width = '100%'; c.style.height = '100%';
  c.style.pointerEvents = 'auto';
  c.style.zIndex = 1;
  const ctx = c.getContext('2d', {alpha:true});
  ctx.lineCap = ctx.lineJoin = 'round';
  return {canvas:c,ctx};
}

function addLayer(opts={}){
  const id = 'layer_'+Date.now();
  const {canvas,ctx} = createCanvasLayer();
  canvasWrap.appendChild(canvas);
  const layer = {
    id, canvas, ctx,
    name: opts.name || 'Ø·Ø¨Ù‚Ø© ' + (layers.length+1),
    visible: true,
    locked: false,
    opacity: 1
  };
  layers.push(layer);
  activeLayerId = id;
  refreshLayersUI();
  saveStateDebounced();
  pushHistory(); // Ø­ÙØ¸ Ù„Ù„ØªØ±Ø§Ø¬Ø¹
  attachPointerEvents(canvas, layer);
  updateCanvasSizes();
  return layer;
}

function removeLayer(id){
  const idx = layers.findIndex(l=>l.id===id);
  if(idx===-1) return;
  const layer = layers[idx];
  canvasWrap.removeChild(layer.canvas);
  layers.splice(idx,1);
  if(layers.length) activeLayerId = layers[layers.length-1].id; else activeLayerId = null;
  refreshLayersUI();
  pushHistory();
  saveStateDebounced();
}

function duplicateLayer(id){
  const orig = layers.find(l=>l.id===id);
  if(!orig) return;
  const {canvas,ctx} = createCanvasLayer();
  canvas.width = orig.canvas.width;
  canvas.height = orig.canvas.height;
  ctx.drawImage(orig.canvas,0,0);
  canvasWrap.appendChild(canvas);
  const layer = {
    id:'layer_'+Date.now(),
    canvas,ctx,
    name: orig.name + ' (Ù†Ø³Ø®Ø©)',
    visible: orig.visible,
    locked: orig.locked,
    opacity: orig.opacity
  };
  layers.push(layer);
  activeLayerId = layer.id;
  attachPointerEvents(canvas, layer);
  refreshLayersUI();
  pushHistory();
  saveStateDebounced();
}

function moveLayerUp(id){
  const i = layers.findIndex(l=>l.id===id);
  if(i<0 || i===layers.length-1) return;
  const temp = layers[i]; layers[i]=layers[i+1]; layers[i+1]=temp;
  reorderCanvases();
  refreshLayersUI();
  pushHistory();
  saveStateDebounced();
}
function moveLayerDown(id){
  const i = layers.findIndex(l=>l.id===id);
  if(i<=0) return;
  const temp = layers[i]; layers[i]=layers[i-1]; layers[i-1]=temp;
  reorderCanvases();
  refreshLayersUI();
  pushHistory();
  saveStateDebounced();
}

function reorderCanvases(){
  // z-index Ø­Ø³Ø¨ ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØµÙÙˆÙØ©
  layers.forEach((l, idx)=>{
    l.canvas.style.zIndex = idx+1;
  });
}

/* ====== UI ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ­Ø© ====== */
function refreshLayersUI(){
  layersPanel.innerHTML = '';
  // Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø£Ø³ÙÙ„ (Ø¢Ø®Ø± ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ù‡Ùˆ Ø§Ù„Ø£Ø¹Ù„Ù‰)
  for(let i=layers.length-1;i>=0;i--){
    const layer = layers[i];
    const item = document.createElement('div');
    item.className = 'layer-item';
    item.style.opacity = layer.visible?1:0.5;
    if(layer.id === activeLayerId) item.style.outline = '2px solid rgba(10,180,255,0.12)';
    const thumb = document.createElement('div');
    thumb.className = 'layer-thumb';
    // ØªÙˆÙ„ÙŠØ¯ ØµÙˆØ±Ø© Ù…ØµØºØ±Ø© Ù…Ù† Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³
    try{
      const data = layer.canvas.toDataURL();
      thumb.style.backgroundImage = `url(${data})`;
      thumb.style.backgroundSize = 'cover';
    }catch(e){}
    const meta = document.createElement('div'); meta.className='layer-meta';
    const title = document.createElement('div'); title.textContent = layer.name; title.className='small';
    const info = document.createElement('div'); info.className='small'; info.style.opacity=0.8;
    info.textContent = `Ø´ÙØ§ÙÙŠØ©: ${Math.round(layer.opacity*100)}% ${layer.locked? ' Â· Ù…Ù‚ÙÙˆÙ„':''}${!layer.visible? ' Â· Ù…Ø®ÙÙŠ':''}`;
    meta.appendChild(title); meta.appendChild(info);

    const actions = document.createElement('div'); actions.className='layer-actions';
    const visBtn = document.createElement('button'); visBtn.textContent = layer.visible? 'ğŸ‘' : 'ğŸ™ˆ';
    visBtn.title = 'Ø§Ø¸Ù‡Ø§Ø±/Ø§Ø®ÙØ§Ø¡'; visBtn.onclick = ()=> { layer.visible = !layer.visible; layer.canvas.style.display = layer.visible? 'block':'none'; refreshLayersUI(); saveStateDebounced(); pushHistory(); };
    const lockBtn = document.createElement('button'); lockBtn.textContent = layer.locked? 'ğŸ”’':'ğŸ”“';
    lockBtn.title='Ù‚ÙÙ„/ÙØªØ­'; lockBtn.onclick = ()=> { layer.locked = !layer.locked; refreshLayersUI(); saveStateDebounced(); pushHistory(); };
    const dupBtn = document.createElement('button'); dupBtn.textContent='â˜'; dupBtn.title='ØªÙƒØ±Ø§Ø±';
    dupBtn.onclick = ()=> duplicateLayer(layer.id);
    const upBtn = document.createElement('button'); upBtn.textContent='â¬†'; upBtn.onclick = ()=> moveLayerUp(layer.id);
    const downBtn = document.createElement('button'); downBtn.textContent='â¬‡'; downBtn.onclick = ()=> moveLayerDown(layer.id);
    const delBtn = document.createElement('button'); delBtn.textContent='ğŸ—‘'; delBtn.onclick = ()=> { if(confirm('Ø­Ø°Ù Ø§Ù„Ø·Ø¨Ù‚Ø©ØŸ')) removeLayer(layer.id); };

    // opacity slider Ù„ÙƒÙ„ Ø·Ø¨Ù‚Ø© (ØµØºÙŠØ±)
    const op = document.createElement('input'); op.type='range'; op.min=0; op.max=100; op.value = Math.round(layer.opacity*100);
    op.style.width='90px'; op.oninput = ()=> { layer.opacity = op.value/100; layer.canvas.style.opacity = layer.opacity; refreshLayersUI(); saveStateDebounced(); pushHistory(); }

    actions.appendChild(visBtn); actions.appendChild(lockBtn); actions.appendChild(dupBtn);
    actions.appendChild(upBtn); actions.appendChild(downBtn); actions.appendChild(delBtn);
    actions.appendChild(op);

    item.appendChild(thumb); item.appendChild(meta); item.appendChild(actions);

    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø¨Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
    item.onclick = (e)=> {
      // Ù„Ø§ Ù†ØºÙŠØ± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù„Ùˆ Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù†ØµØ±
      if(e.target.tagName.toLowerCase()==='button' || e.target.tagName.toLowerCase()==='input') return;
      activeLayerId = layer.id;
      refreshLayersUI();
    };

    layersPanel.appendChild(item);
  }
}

/* ====== Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø±Ø³Ù… ====== */
function attachPointerEvents(canvas, layer){
  // Ø¯Ø¹Ù… Ø§Ù„Ù„Ù…Ø³ ÙˆØ§Ù„ÙØ£Ø±Ø©
  let drawing = false;
  let last = null;
  let pointers = {}; // Ù„Ø¯Ø¹Ù… Ø§Ù„Ù„Ù…Ø³ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ (Ù†ÙØ±Ù‘Ù‚ Ø¨Ø¥ØµØ¯Ø§Ø± pointerId)
  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    if(e.touches && e.touches[0]) {
      const t = e.touches[0];
      return {x:(t.clientX-rect.left)*(canvas.width/rect.width), y:(t.clientY-rect.top)*(canvas.height/rect.height)};
    } else if(e.clientX!==undefined){
      return {x:(e.clientX-rect.left)*(canvas.width/rect.width), y:(e.clientY-rect.top)*(canvas.height/rect.height)};
    } else return null;
  }

  function startDraw(e){
    if(layer.locked) return;
    e.preventDefault();
    drawing = true;
    last = getPos(e);
    drawLine(last, last, layer); // Ù†Ù‚Ø·Ù‡
    pushHistory();
  }
  function moveDraw(e){
    if(!drawing) return;
    e.preventDefault();
    const pos = getPos(e);
    if(!pos) return;
    drawLine(last, pos, layer);
    last = pos;
  }
  function endDraw(e){
    if(!drawing) return;
    drawing=false; last=null;
    saveStateDebounced();
  }

  // Ø¯Ø¹Ù… pointer events
  canvas.addEventListener('pointerdown', (ev)=>{
    if(tool==='move') return; // Ù„Ø§ Ù†Ø±Ø³Ù…
    canvas.setPointerCapture && canvas.setPointerCapture(ev.pointerId);
    startDraw(ev);
  });
  canvas.addEventListener('pointermove', (ev)=> {
    if(tool==='move') return;
    moveDraw(ev);
  });
  canvas.addEventListener('pointerup', (ev)=> { endDraw(ev); canvas.releasePointerCapture && canvas.releasePointerCapture(ev.pointerId); });
  canvas.addEventListener('pointercancel', (ev)=> endDraw(ev));

  // Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ù„Ù…Ø³
  canvas.addEventListener('touchstart', (e)=> e.preventDefault(), {passive:false});
}

function drawLine(from, to, layer){
  const ctx = layer.ctx;
  ctx.save();
  const sz = parseInt(sizeInput.value,10) || 8;
  ctx.lineWidth = sz;
  if(tool==='eraser'){
    ctx.globalCompositeOperation = 'destination-out';
    ctx.strokeStyle = 'rgba(0,0,0,1)';
  } else {
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = colorInput.value || '#00bfff';
  }
  ctx.beginPath();
  ctx.moveTo(from.x, from.y);
  ctx.lineTo(to.x, to.y);
  ctx.stroke();
  ctx.restore();
}

/* ====== Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ====== */
function setTool(t){
  tool = t;
  document.getElementById('brushBtn').style.outline = t==='brush'? '2px solid rgba(10,180,255,0.15)':'';
  document.getElementById('eraserBtn').style.outline = t==='eraser'? '2px solid rgba(10,180,255,0.15)':'';
  document.getElementById('moveBtn').style.outline = t==='move'? '2px solid rgba(10,180,255,0.15)':'';
  // Ù„Ùˆ move: Ù†Ø³Ù…Ø­ Ø¨Ø³ Ø¨Ø³Ø­Ø¨ Ø§Ù„ØµÙØ­Ø©ØŒ Ù„ÙƒÙ† Ù„Ù„Ø§Ø®ØªØµØ§Ø± Ù„Ù… Ø£Ø¶Ù ØªØ­Ø±ÙŠÙƒ Ø¹Ù†Ø§ØµØ±
}

setTool('brush');

/* ====== Ù…Ø³Ø­ / Ø¯Ù…Ø¬ / ØªØµØ¯ÙŠØ± ====== */
function clearActiveLayer(){
  const layer = layers.find(l=>l.id===activeLayerId);
  if(!layer) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø¨Ù‚Ø© Ù…Ø®ØªØ§Ø±Ø©');
  const c = layer.canvas;
  layer.ctx.clearRect(0,0,c.width,c.height);
  saveStateDebounced(); pushHistory();
}

function exportPNG(){
  // Ù†Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø¹Ù„Ù‰ ÙƒØ§Ù†ÙØ§Ø³ Ù…Ø¤Ù‚Øª
  if(layers.length===0) return alert('Ù…Ø§ÙƒÙˆ Ø·Ø¨Ù‚Ø§Øª');
  const w = layers[0].canvas.width, h = layers[0].canvas.height;
  const out = document.createElement('canvas'); out.width=w; out.height=h;
  const octx = out.getContext('2d');
  // Ø±Ø³Ù… Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„Ø£Ø¹Ù„Ù‰
  for(const l of layers){
    if(!l.visible) continue;
    octx.globalAlpha = l.opacity;
    octx.drawImage(l.canvas,0,0);
  }
  const data = out.toDataURL('image/png');
  const a = document.createElement('a'); a.href=data; a.download='drawing.png'; a.click();
}

function exportFlattenedPNG(){
  exportPNG();
}

/* ====== Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© ====== */
const STORAGE_KEY = 'neon_draw_v1';
let saveTimeout = null;
function saveState(){
  try{
    const payload = {
      width: DEFAULT_WIDTH,
      height: DEFAULT_HEIGHT,
      layers: layers.map(l=>{
        return {id:l.id,name:l.name,visible:l.visible,locked:l.locked,opacity:l.opacity,data: l.canvas.toDataURL()};
      })
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    //console.log('saved');
  }catch(e){ console.warn('save failed',e) }
}
function saveStateDebounced(){
  if(saveTimeout) clearTimeout(saveTimeout);
  saveTimeout = setTimeout(saveState, 600);
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return false;
  try{
    const data = JSON.parse(raw);
    // ØªÙØ±ÙŠØº Ø£ÙŠ Ø·Ø¨Ù‚Ø§Øª Ø­Ø§Ù„ÙŠØ©
    layers.forEach(l=> canvasWrap.removeChild(l.canvas));
    layers = [];
    for(const li of data.layers){
      const {canvas,ctx} = createCanvasLayer();
      canvasWrap.appendChild(canvas);
      const layer = { id: li.id, canvas, ctx, name:li.name, visible:li.visible, locked:li.locked, opacity: li.opacity || 1 };
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
      if(li.data){
        const img = new Image();
        img.onload = ()=> {
          ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.drawImage(img,0,0);
        };
        img.src = li.data;
      }
      canvas.style.display = layer.visible? 'block':'none';
      canvas.style.opacity = layer.opacity;
      attachPointerEvents(canvas, layer);
      layers.push(layer);
    }
    activeLayerId = layers.length? layers[layers.length-1].id : null;
    reorderCanvases();
    refreshLayersUI();
    return true;
  }catch(e){ console.warn('load failed',e); return false; }
}

/* ====== Ù…Ø³Ø§Ø¹Ø¯Ø©: Ù…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡ ÙˆØªÙ‡ÙŠØ¦Ø© ====== */
function resetAll(){
  layers.forEach(l=> canvasWrap.removeChild(l.canvas));
  layers = [];
  activeLayerId = null;
  refreshLayersUI();
}

function init(){
  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¨Ø­Ø¬Ù… Ù…Ù†Ø§Ø³Ø¨
  canvasWrap.style.width = '100%';
  canvasWrap.style.height = 'calc(100% - 0px)';

  // Ø­Ø§ÙˆÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†ØŒ ÙˆØ¥Ù„Ø§ Ø£Ù†Ø´Ø¦ Ø·Ø¨Ù‚Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  const ok = loadState();
  if(!ok){
    addLayer({name:'Ø§Ù„Ø®Ù„ÙÙŠØ©'});
    addLayer({name:'Ø§Ù„Ø±Ø³Ù… 1'});
  }
  refreshLayersUI();
  updateCanvasSizes();
  window.addEventListener('resize', updateCanvasSizes);
}
init();

/* ====== ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø¹Ù†ØµØ± (Ù…Ù‚Ø§Ø³ Ø«Ø§Ø¨Øª Ø¯Ø§Ø®Ù„ÙŠ) ====== */
function updateCanvasSizes(){
  // Ù†Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ØŒ Ù„ÙƒÙ† Ù†ÙƒØ¨Ø±/Ù†ØµØºØ± Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„
  const rect = canvasWrap.getBoundingClientRect();
  const scale = Math.min(rect.width / DEFAULT_WIDTH, rect.height / DEFAULT_HEIGHT);
  const displayW = DEFAULT_WIDTH * scale;
  const displayH = DEFAULT_HEIGHT * scale;
  // Ø¶Ø¨Ø· Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ù„ÙŠØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ Ù…Ø±ÙƒØ²ÙŠ
  canvasWrap.style.justifyContent = 'center';
  canvasWrap.style.alignItems = 'center';

  // Ø¶Ø¨Ø· Ø³ØªØ§ÙŠÙ„ Ù„ÙƒÙ„ ÙƒØ§Ù†ÙØ§Ø³ Ù„ÙŠØ¹Ø±Ø¶ Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ (Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ø§ ØªØªØºÙŠØ±)
  layers.forEach((l)=>{
    l.canvas.style.width = displayW + 'px';
    l.canvas.style.height = displayH + 'px';
    l.canvas.style.pointerEvents = l.visible? 'auto' : 'none';
  });
}

/* ====== ØªØ±Ø§Ø¬Ø¹ / Ø§Ø¹Ø§Ø¯Ø© â€” Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ø³ÙŠØ· ====== */
let history = [];
let historyIndex = -1;
function pushHistory(){
  // ØªØ®Ø²ÙŠÙ† Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø©: Ù„ÙƒÙ„ ÙƒØ§Ù†ÙØ§Ø³ ØµÙˆØ±Ø© dataURL
  const snapshot = layers.map(l=> ({id:l.id, name:l.name, visible:l.visible, locked:l.locked, opacity:l.opacity, data: l.canvas.toDataURL()}));
  history = history.slice(0, historyIndex+1);
  history.push(snapshot);
  historyIndex = history.length-1;
  if(history.length>30) history.shift();
}
function applySnapshot(snap){
  if(!snap) return;
  // ØªÙ‡ÙŠØ¦Ø©
  resetAll();
  for(const li of snap){
    const {canvas,ctx} = createCanvasLayer();
    canvasWrap.appendChild(canvas);
    const layer = { id: li.id, canvas, ctx, name:li.name, visible:li.visible, locked:li.locked, opacity: li.opacity || 1 };
    if(li.data){
      const img = new Image();
      img.onload = ()=> ctx.drawImage(img,0,0);
      img.src = li.data;
    }
    canvas.style.display = layer.visible? 'block':'none';
    canvas.style.opacity = layer.opacity;
    attachPointerEvents(canvas, layer);
    layers.push(layer);
  }
  activeLayerId = layers.length? layers[layers.length-1].id : null;
  reorderCanvases();
  refreshLayersUI();
}
function undo(){
  if(historyIndex<=0) return;
  historyIndex--;
  applySnapshot(history[historyIndex]);
  saveStateDebounced();
}
function redo(){
  if(historyIndex>=history.length-1) return;
  historyIndex++;
  applySnapshot(history[historyIndex]);
  saveStateDebounced();
}

/* ====== ØªÙ†Ø²ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ù„Ø§ÙŠØ±Ø² ÙƒØµÙˆØ± Ù…Ù†ÙØµÙ„Ø© (Ø¨Ø³ÙŠØ·ØŒ Ø¨Ø¯ÙˆÙ† ZIP Ø­Ù‚ÙŠÙ‚ÙŠ) ====== */
function downloadLayersAsImages(){
  if(layers.length===0) return alert('Ù…Ø§ÙƒÙˆ Ø·Ø¨Ù‚Ø§Øª');
  layers.forEach((l, idx)=>{
    const a = document.createElement('a');
    a.href = l.canvas.toDataURL();
    a.download = (l.name||'layer') + '_' + (idx+1) + '.png';
    a.click();
  });
}

/* ====== ØªØ­Ù…ÙŠÙ„/Ø­ÙØ¸ ÙŠØ¯ÙˆÙŠ (Ø£Ø²Ø±Ø§Ø± Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ù…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§) ====== */
/* Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Øª: Ø­ÙØ¸ Ø¥Ù„Ù‰ Ø®Ø§Ø¯Ù… Ø£Ùˆ zipØŒ Ø£Ùˆ Ø£Ø¯ÙˆØ§Øª ÙØ±Ø´ Ù…ØªÙ‚Ø¯Ù…Ø©ØŒ Ø£Ùˆ Ø¶Ø¨Ø· Ø§Ù„Ø£Ø¯Ù„Ø©. */

</script>
</body>
</html>